using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.CartridgeLoader.Cartridges;
using Content.Client.GameTicking.Managers;

namespace Content.Client.CartridgeLoader.Cartridges;

[GenerateTypedNameReferences]
public sealed partial class MessagesUiFragment : BoxContainer
{

    public event Action<string>? OnMessageSent;
    public event Action<int?>? OnButtonPressed;

    public MessagesUiFragment()
    {
        RobustXamlLoader.Load(this);
        Input.OnTextEntered += _ =>
        {
            if (!string.IsNullOrEmpty(Input.Text))
                OnMessageSent?.Invoke(Input.Text);
            Input.Clear();
        };

        HeaderButton.OnPressed += _ => OnButtonPressed?.Invoke(null);

        UpdateState(MessagesUiStateMode.UserList, [], null);
    }

    public void UpdateState(MessagesUiStateMode mode, List<(string, int?)>? contents, string? name)
    {
        MessageContainer.DisposeAllChildren();
        Input.Orphan();
        HeaderBox.Orphan();
        BackButton.Orphan();

        if (contents == null) return;
        if (mode == MessagesUiStateMode.Chat)
        {
            HeaderLabel.Text = name;

            foreach (var (senderName, message) in contents)
            {
                AddNote($"{senderName} {message}");
            }

            OverContainer.AddChild(Input);
            OverContainer.AddChild(HeaderBox);
            OverContainer.AddChild(BackButton);
        }
        else if (mode == MessagesUiStateMode.Error)
        {
            HeaderLabel.Text = Loc.GetString("messages-pda-error-header");
            AddNote(Loc.GetString("messages-pda-error-message"));
            OverContainer.AddChild(HeaderBox);
        }
        else
        {
            foreach (var (user, userUid) in contents)
            {
                AddButton(userUid, user);
            }
        }
    }

    ///<summary>
    /// Adding a button for selecting a chat
    ///</summary>
    private void AddButton(int? userUid, string userName)
    {
        var button = new Button
        {
            Text = userName,
            HorizontalExpand = true,
            ClipText = true,
            MinWidth = 60
        };
        button.OnPressed += _ => OnButtonPressed?.Invoke(userUid);
        MessageContainer.AddChild(button);
    }

    ///<summary>
    /// Adding a text label to the message container
    ///</summary>
    private void AddNote(string note)
    {
        MessageContainer.AddChild(new Label
        {
            Text = note,
            HorizontalExpand = true,
            ClipText = false
        });
    }
}
